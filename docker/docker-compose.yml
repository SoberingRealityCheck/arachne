services:

 builder:
   build: .
   # restart: no
   container_name: pkg_builder
   volumes:
     - /home/clay/ros:/home/ros
     - /home/clay/arachne:/ros2
   #devices:
    # - /dev/ttyUSB0:/dev/ttyUSB0
   command: >
       bash -c "apt update && 
       apt install -y libcap-dev &&
       cd ros2/ros2_ws && 
       colcon build && 
       source install/setup.sh &&
       colcon test"
   #environment:
     #- ROS_DOMAIN_ID=737

 ros-shell:
   build: .
   # restart: no
   container_name: ros-shell
   ports: 
     - "3332:3332"
   volumes:
     - /home/clay/ros:/home/ros
     - /home/clay/arachne:/ros2
     - /dev:/dev  # Mount /dev for hardware access
  
   devices:
     - /dev/ttyUSB0:/dev/ttyUSB0
     - "/dev/video0:/dev/video0" 
   privileged: true  # Required for camera access
   tty: true
   command: >
       bash -c "cd ros2/ros2_ws &&  
       source install/setup.sh && 
       source /ros_entrypoint.sh &&
       tail -f /dev/null"
 
 network-tunnel-api:
    build:
      context: .
      dockerfile: Dockerfile.tunnel-api
    restart: unless-stopped
    container_name: arachne-tunnel-api
    volumes:
      - /home/clay/ros:/home/ros
      - /home/clay/arachne:/ros2
    ports:
      - "127.0.0.1:8080:8080"  # localhost only
    environment:
      - API_KEY=${API_KEY:-your-secure-api-key}
      - API_PORT=8080  # Explicitly set (same as default)
    networks:
      - ros2_network
    #restart: unless-stopped
    #command: "tail -f /dev/null"
    command: >
      bash -c "cd ros2/ros2_ws && 
      source install/setup.sh && 
      source /ros_entrypoint.sh &&
      ros2 run arachne tunnel_api_node"

 imu:
    build:
      context: .
    # restart: unless-stopped
    container_name: imu-connection
    volumes:
      - /home/clay/ros:/home/ros
      - /home/clay/arachne:/ros2
    devices:  
      - "/dev/i2c-1:/dev/i2c-1"  
    command: >
      bash -c "cd ros2/ros2_ws && 
      source install/setup.sh && 
      source /ros_entrypoint.sh &&
      source ../venv/bin/activate &&
      ros2 run arachne imu_node"

 rosboard:
    build:
      context: .
    restart: always
    container_name: rosboard
    volumes:
      - /home/clay/ros:/home/ros
      - /home/clay/arachne:/ros2
    ports:
      - "127.0.0.1:8888:8888"  # rosboard webserver is on 8888
    networks:
      - ros2_network
    #command: "tail -f /dev/null"
    command: >
      bash -c "cd ros2/ros2_ws && 
      source install/setup.sh && 
      source /ros_entrypoint.sh &&
      cd src/rosboard &&
      ./run"
 
 robot_state:
     build:
       context: .
     restart: always
     container_name: robot_state
     volumes:
       - /home/clay/ros:/home/ros
       - /home/clay/arachne:/ros2
     networks:
        - ros2_network
     command: >
       bash -c "cd ros2/ros2_ws && 
       source install/setup.sh && 
       source /ros_entrypoint.sh &&
       ros2 run arachne robot_state_node"

 camera_feed:
     build:
       context: .
     restart: unless-stopped
     container_name: camera_feed
     volumes:
       - /home/clay/ros:/home/ros
       - /home/clay/arachne:/ros2
       - /dev:/dev  # Mount /dev for hardware access
       - /sys:/sys:ro  # Mount /sys for device detection
       - /lib/modules:/lib/modules:ro  # Mount kernel modules
       - /usr/src:/usr/src:ro  # Mount kernel headers if needed
       - /run/udev:/run/udev:ro  # Mount udev runtime data
       - /proc:/proc  # Mount proc filesystem (needs write access for container init)
       - /usr/share/libcamera:/usr/share/libcamera:ro  # Mount libcamera IPA files
     devices:
        - "/dev/video0:/dev/video0"  # Assuming the camera is at /dev/video0
        - "/dev/media0:/dev/media0"  # Media controller device
        - "/dev/v4l-subdev0:/dev/v4l-subdev0"  # V4L2 subdevices
        - "/dev/v4l-subdev1:/dev/v4l-subdev1"
        - "/dev/v4l-subdev2:/dev/v4l-subdev2"
        - "/dev/v4l-subdev3:/dev/v4l-subdev3"
     cap_add:
        - SYS_MODULE    # Allow loading kernel modules
        - SYS_RAWIO     # Allow raw I/O operations
        - SYS_ADMIN     # Allow system administration operations
        - MKNOD         # Allow creating device nodes
        - DAC_OVERRIDE  # Bypass file permission checks
        - SETUID        # Allow setuid operations
        - SETGID        # Allow setgid operations
     security_opt:
        - apparmor:unconfined  # Disable AppArmor restrictions
     environment:
        - LIBCAMERA_LOG_LEVELS=*:DEBUG  # Enable debug logging for libcamera
        - LIBCAMERA_IPA_CONFIG_PATH=/usr/share/libcamera/ipa
        - LIBCAMERA_IPA_MODULE_PATH=/usr/lib/libcamera
     group_add:
        - video         # Add to video group
        - dialout       # Add to dialout group (sometimes needed for hardware)
     networks:
        - ros2_network
     privileged: true  # Required for camera access and module loading
     command: >
       bash -c "/load_camera_modules.sh && 
       cd ros2/ros2_ws && 
       source install/setup.sh && 
       source /ros_entrypoint.sh &&
       ros2 run arachne camera_node"
      # pip install picamera2 --break-system-packages &&
      # ros2 run arachne camera_feed_node"

 test_camera:
    build:
      context: ./camera
    restart: unless-stopped
    container_name: test_camera
    volumes:
      - /home/clay/ros:/home/ros
      - /home/clay/arachne:/ros2
    devices:
        - "/dev/video0:/dev/video0"
        - "/run/udev/:/run/udev/"  # Assuming the camera is at /dev/video0
    networks:
        - ros2_network
    group_add: 
      - video
    command: >
      bash -c "cd ros2/ros2_ws && 
      source install/setup.sh && 
      source /ros_entrypoint.sh &&
      
      pip install picamera2 --break-system-packages &&
      ros2 run arachne test_camera_node"


networks:
  ros2_network:
    driver: bridge